import SwiftUI

struct Solution6View: View {
    enum Direction {
        case up
        case right
        case down
        case left

        var degrees: Double {
            switch self {
            case .up:
                0
            case .right:
                90
            case .down:
                180
            case .left:
                270
            }
        }

        var opposite: Direction {
            switch self {
            case .up:
                .down
            case .right:
                .left
            case .down:
                .up
            case .left:
                .right
            }
        }

        func turn() -> Direction {
            switch self {
            case .up:
                return .right
            case .right:
                return .down
            case .down:
                return .left
            case .left:
                return .up
            }
        }
    }

    struct Point: Hashable {
        var x, y: Int

        mutating func advance(in direction: Direction) {
            switch direction {
            case .up:
                y -= 1
            case .right:
                x += 1
            case .down:
                y += 1
            case .left:
                x -= 1
            }
        }
    }

    struct Player: Hashable {
        var position: Point
        var direction: Direction

        var lookahead: Point {
            var mutablePosition = position
            mutablePosition.advance(in: direction)
            return mutablePosition
        }

        mutating func advance() {
            position.advance(in: direction)
        }

        mutating func turn() {
            direction = direction.turn()
        }
    }

    @State
    private var map: [[String]] = []

    @State
    private var player: Player?

    @State
    private var originalPosition = Point(x: 0, y: 0)

    @State
    private var visited: [Point: Set<Direction>] = [:]

    @State
    private var runner: Player?

    @State
    private var possibleObstacles: Set<Point> = []

    var body: some View {
        Grid(horizontalSpacing: 1, verticalSpacing: 1) {
            ForEach(Array(map.enumerated()), id: \.offset) { y, line in
                GridRow {
                    ForEach(Array(line.enumerated()), id: \.offset) { x, block in
                        ZStack {
                            let point = Point(x: x, y: y)
                            if let player, point == player.position {
                                Color.cyan
                                    .border(possibleObstacles.contains(point) ? Color.red : .clear, width: 2)
                                    .border(Color.blue, width: 0.5)
                                Image(systemName: "chevron.up")
                                    .scaleEffect(x: 1.5, y: 1.5)
                                    .foregroundStyle(Color.white)
                                    .rotationEffect(.degrees(player.direction.degrees))
                            } else {
                                switch block {
                                case "#":
                                    Color.brown
                                    Image(systemName: "archivebox")
                                case ".", "^":
                                    if let visitedDirections = visited[point] {
                                        Color(white: 0.8)
                                        Color.cyan.opacity(0.3)
                                            .border(possibleObstacles.contains(point) ? Color.red : .clear, width: 2)
                                            .border(Color.black, width: 0.5)

                                        if visitedDirections.contains(.up) {
                                            Image(systemName: "chevron.up")
                                                .foregroundStyle(Color.white)
                                                .scaleEffect(x: 0.7, y: 0.7)
                                                .offset(y: -10)
                                        }
                                        if visitedDirections.contains(.right) {
                                            Image(systemName: "chevron.right")
                                                .foregroundStyle(Color.white)
                                                .scaleEffect(x: 0.7, y: 0.7)
                                                .offset(x: 10)
                                        }
                                        if visitedDirections.contains(.down) {
                                            Image(systemName: "chevron.down")
                                                .foregroundStyle(Color.white)
                                                .scaleEffect(x: 0.7, y: 0.7)
                                                .offset(y: 10)
                                        }
                                        if visitedDirections.contains(.left) {
                                            Image(systemName: "chevron.left")
                                                .foregroundStyle(Color.white)
                                                .scaleEffect(x: 0.7, y: 0.7)
                                                .offset(x: -10)
                                        }
                                    } else {
                                        Color(white: 0.8)
                                            .border(possibleObstacles.contains(point) ? Color.red : .clear, width: 2)
                                            .border(Color.black, width: 0.5)
                                    }
                                default:
                                    Color.clear
                                }

                                if point == originalPosition {
                                    Image(systemName: "house.fill")
                                        .opacity(0.2)
                                        .foregroundStyle(Color.white)
                                }

                                if let runner, point == runner.position {
                                    Image(systemName: "scope")
                                        .foregroundStyle(Color.green)
                                        .bold()
                                        .scaleEffect(x: 1.5, y: 1.5)
                                    Image(systemName: "chevron.up")
                                        .scaleEffect(x: 1.5, y: 1.5)
                                        .foregroundStyle(Color.green)
                                        .rotationEffect(.degrees(runner.direction.degrees))
                                }
                            }
                        }
                        .frame(width: 36, height: 36)
                        .cornerRadius(4)
                    }
                }
            }
        }
        .padding()
        .task {
            map = exampleInput.lines().map { $0.map(String.init) }
            let xBounds = 0..<map[0].count
            let yBounds = 0..<map.count

            func isInBounds(point: Point) -> Bool {
                xBounds.contains(point.x)
                && yBounds.contains(point.y)
            }

            player = Player(position: Point(x: 0, y: 0), direction: .up)
            var obstacles: Set<Point> = []

            outerLoop:
            for (y, line) in map.enumerated() {
                for (x, block) in line.enumerated() {
                    switch block {
                    case "^":
                        player!.position = Point(x: x, y: y)
                        originalPosition = player!.position
                    case "#":
                        obstacles.insert(Point(x: x, y: y))
                    default:
                        break
                    }
                }
            }

            var path: [Player] = [player!]
            var visited: [Point: Set<Direction>] = [player!.position: [player!.direction]]
            while true {
                let playerLookahead = player!.lookahead
                if obstacles.contains(playerLookahead) {
                    player!.turn()
                } else {
                    if isInBounds(point: playerLookahead) {
                        player!.advance()
                        visited[player!.position] = visited[player!.position, default: []].union([player!.direction])
                        path.append(player!)
                    } else {
                        break
                    }
                }

                try? await Task.sleep(for: .milliseconds(100))
            }

            for snapshot in path {
                let snapshotLookahead = snapshot.lookahead
                let runnerObstacles = obstacles.union([snapshotLookahead])

                runner = snapshot
                while true {
                    let runnerLookahead = runner!.lookahead
                    if runnerObstacles.contains(runnerLookahead) {
                        runner!.turn()
                    } else {
                        if isInBounds(point: runnerLookahead) {
                            runner!.advance()
                        } else {
                            break
                        }
                    }

                    if runner == snapshot {
                        possibleObstacles.insert(snapshotLookahead)
                        break
                    }

                    try? await Task.sleep(for: .milliseconds(50))
                }
            }
        }
    }
}

#Preview {
    Solution6View()
        .frame(width: 400, height: 400)
}

private let exampleInput =
"""
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

private let input =
"""
..........##.....................................#............#........................#.....#........#...........#...............
...........#.............#.....#....................#...........#.#..............#.#......................................#.......
.#..............#...............................#.......#.#...................#...............#...............#..#...........#....
.#............................#.............................................................................#.#...................
...............#..........#............#...........................................#....#...#..........................#..........
..##.#..#......#.....................#..#......#................#..........................................#................#.....
.......#.....#...........................................#........#...............................#.#.............................
.........#...............#......#............#...................#...........#.........#..#...#...................................
#.....#.#....................................#.......................................................##..#...##..#..#.............
.............................#...#.......#...............................#.#...............#......................................
.....#................................#..........................#....................#...........................................
.......#............#..#................................................................................#..........#...#..........
...........#.............................................................#...............#................................#.....#.
.....................................................#.........#.....#..#.....#..................#.......#.....#...........#......
.#..........#................#..................#........#..............................................#....#..................#.
.....................#......#..........#...........#................#..#..#............................#...##.........#...........
.................#.....................................................................................#..........................
..........................#.....................................#.#..................................................#.#..........
............#....#........#...................................#...................................................#...............
............#........................#........##..............#....#.............#............#......#........#...................
....................#.#........#..........................#...........#.............#...............#.............##.......#......
...............................................#..................................#...................................#....##.....
...#.....#.......................................#..........#......................#.............#.............#.##.......#.......
........#......##...................................................................................#.............................
...#.................................#.....................................#......................................#.........#.....
....#.................#......#.........#.........................................................................#........#....#..
..........................#..#.......#............................##.............................................#.........##..#..
......................#......................................#......................#................#.........#..#...............
....#.....................................#...................#..............#..........................#...........#...#.........
...............#........#...............#..........#.....#..............................#....................................#.#..
......#......................#.......#.#...................#.............#...#.........#.....#....................................
.....#..#...............##....................................................#..#...#........................#..................#
......#.#..........#...#.................#...............#..........................................#...#.#.......................
..........#.......................................................................................................##..............
......................#..#...#......#.....................................................#.........#.........#...................
...................................................#...#.........#.....#......................#...............................#...
........................#...................................^..............................#.............#..........#...#.........
........#............................#.....................#......#...........##...........#......................................
..........#..................#........#...........................................................................................
.....#......................#.....#.............#....................#...............#...........##.......#..................##...
........#......................................#................................................#.....................#...........
......#.........#..............#.................................................................#.......##..#.#..................
........#......................................#...................#......................#.......................................
..#...............#....##.....#........................#.#.........#........#....#...................#.............#...#.........#
.............#..............#....#....#................#.....................................#...............#..................#.
..............#...........................................................................#..##..#...#.......#..........#.........
#...........#........................#..#......#..#.........#........#...#..............#............#.....#.................#...#
.....................#........................................#.................#.#..................#.............#.........#....
.............#.....................................................#.#....................................#.......................
.............#....#.............#.........................................................................#...........#...........
#.................#...#...#...............#..........#.........................##......#.....#..#.............................#...
#................#........#.......#.....#...............#..................................#.#.............................#......
.........#.......#.............#...................................................................................#..........#...
......#..............................................................................##............................#..........#...
..............#..................................................#...................................#..........................#.
.................................................................#.#...........#................#..........#..........#.......#.#.
...................................#.....................#..#...........................................................#.........
......................................................................................#.............#.............................
.....#......................................................................#......#....#.........#....#..#.......................
..................#.............................................................#.........................#.......................
......................#......#..........#..#............................#....#.........#.........#................................
..#...........#.......................#....#....................................#.......#.................................#.......
...................#.......................................................................................#..............#.......
.....#....................................#......#............#...##........#...............#......................#...........#..
......................................#.......................#.........#.#.........................................#.............
...#..............................................#................................................##...........................#.
.......................#.................................................................#.......................................#
.#...........#..#...................#.#......#................#......................................................#............
.......................................................................##..........#......#................#.......#.......#......
#..#...#...........................................#......#...............#.......................................................
....#.....#...........................#...........#...............##..............................................................
...#.......#.......................................................................................#............#.................
.............................................................................#...#.....................#...#......................
...................#.................................#.......#...........................#.....#.................................#
.........................................#........#....#.............#.............#...........................#..................
....#.....................................................................................#.#.#.......................#.#.........
..............................................................#..........#............................................#...........
.........#.#.............................#...#..........................#....................#....................................
......................................#.#......#..................................................................................
.................................................................................................................#................
..............#...................................................................................................................
...................................................#....................................................................##........
................#........................................#..............................................#...............#.........
.........#....#...#......#....................#.#.......................................#.............#.....#..............#....#.
.............................................................................................................##.....#..#..........
....#.............................#......#.....................................................#......................#.......#...
..#.................#........................#....#...##...................................#...............#......................
.........#..................................#.................#...#..#..........##................................................
......##.......................................................#...........#......................................................
......#..............................#...................##....#..................................................................
..................#.........#.................................................#.......#..................#........................
.........................#...........................................#.......#...........................................#........
............#.#...................#.#....#.................................#......##...........................................#..
..#....................#.....................#.........................#..............#.....#.........#...........................
..#............................................#.........................#....................#..................................#
...........................#......#...............................................................#......#..........#..........#..
.......................#.....#..................#...................................#.............#....#.....................#....
....................................................................#.....#....#..................................................
..#................#...#..........................................................................................................
.........................##.....#.................#.............#....................#...............#..............#......#.#....
.......................#...................##......................................#....#...............#........#.........#......
......#..#.........#............................................................#................................#......#.........
#........................#..................#...............................................#.#........#..........................
..........#................#...#.....................................................#............#...............................
............#................................................#.#...............#............#................................#....
..#............................................#....#....#.#.#................................#....................#..............
.........#...........................##.............#..#.................#........................#............................#..
..........................##......................#..............................#..................#.............................
.........#........#.......#..........#...........#.............................#...........................#.......#..............
..........................#................#......................................................................................
..........................#...............#..................#....................................#.........#....#..........#.....
..................#..#..................................................................#........#................................
##..#.......#..............#..#..............##.............#...#..#.........##.......................................#......#....
.............#.........#........#....................................................#................#.....#.....................
......#...................................#.....#................#..........................#.....................................
..#.......................#...#.#...#...........#..........#...................................#.............#.....#..............
..........#...#......................##...........................................................................................
....#............................#.#...................#....................#................#...........#..................#.....
.......#......#................#......................#......#........##..#....................#..................................
.......#..................#....#.....................................................................................#............
..................#......#................................#.........................#....#.............................#...#......
.................#.............#..........#....#.........................#..................................#.....##...........##.
............#..#............................................................................##...#.#....#....#.......##.#.......#.
......................#............................#.........#.....#.#.......##........................#..........................
...........#........................#..##........#....#.......#....#.#.....##.....................#.......#......#...............#
.................#...........#.......#..........#................................................#......................#.........
................#.......#.#.....................................................................................#.................
........................................#...#......#.......................................#...........#..........................
....#........##...............#...........#..................................................................#....................
#....................#...................#.........#....................................................................#.........

"""
